---
# Raptor Pi Setup Playbook
# Configures a fresh Rev Pi OS for raptor-controls kiosk mode
#
# Usage:
#   ansible-playbook -i inventory.yml playbook.yml --ask-pass --ask-become-pass
#
# Each Pi ships with a different factory password, so use --ask-pass
# After setup, all Pis will have the standardized password
#
# Updated: 2026-01-18 - Added network-spinner, gateway, nginx, frontend

- name: Configure Raptor Pi
  hosts: all
  become: yes

  vars:
    # Kiosk now points to localhost (nginx serves static frontend)
    kiosk_url: "http://localhost/dashboard/"
    pi_user: "pi"
    pi_password: "b8rqse"  # Standardized password after setup

    # Repository URLs
    raptor_core_repo: "https://github.com/Sioux-Steel-Solutions/raptor-core.git"
    raptor_network_spin_repo: "https://github.com/Sioux-Steel-Solutions/raptor-network-spinner.git"
    raptor_gateway_repo: "https://github.com/Sioux-Steel-Solutions/raptor-gateway.git"
    raptor_frontend_repo: "https://github.com/Sioux-Steel-Solutions/raptor-frontend.git"

    # MQTT Configuration
    cloud_mqtt_url: "tcp://3.141.116.27:1883"
    cloud_mqtt_ws_url: "ws://3.141.116.27:9001"
    cloud_mqtt_user: "raptor"
    cloud_mqtt_pass: "raptorMQTT2025"

    # Device identity (override in inventory per-device)
    raptor_site: "shop"
    raptor_device: "revpi-{{ raptor_id }}"

  tasks:
    # ============================================
    # STANDARDIZE PASSWORD
    # ============================================
    - name: Set standardized password for pi user
      user:
        name: "{{ pi_user }}"
        password: "{{ pi_password | password_hash('sha512') }}"

    # ============================================
    # PACKAGES
    # ============================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      apt:
        name:
          - chromium-browser
          - docker.io
          - docker-compose
          - git
          - zram-tools
          - firefox-esr
          - nginx
        state: present

    # ============================================
    # DOCKER SETUP
    # ============================================
    - name: Add pi user to docker group
      user:
        name: "{{ pi_user }}"
        groups: docker
        append: yes

    - name: Enable Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Enable containerd service
      systemd:
        name: containerd
        enabled: yes
        state: started

    # ============================================
    # RAPTOR-CORE DEPLOYMENT
    # ============================================
    - name: Clone raptor-core repository
      git:
        repo: "{{ raptor_core_repo }}"
        dest: "/home/{{ pi_user }}/raptor-core"
        version: main
        force: yes
      become_user: "{{ pi_user }}"

    - name: Set raptor-core directory ownership
      file:
        path: "/home/{{ pi_user }}/raptor-core"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        recurse: yes

    - name: Build and start raptor-core with docker-compose
      community.docker.docker_compose:
        project_src: "/home/{{ pi_user }}/raptor-core"
        build: yes
        state: present
      become_user: "{{ pi_user }}"
      ignore_errors: yes  # Fallback to shell if module not available

    - name: Fallback - Start raptor-core with docker-compose (shell)
      shell: |
        cd /home/{{ pi_user }}/raptor-core
        docker-compose up -d --build
      become_user: "{{ pi_user }}"
      when: false  # Set to true if above task fails

    # ============================================
    # RAPTOR-NETWORK-SPINNER DEPLOYMENT
    # ============================================
    - name: Clone raptor-network-spinner repository
      git:
        repo: "{{ raptor_network_spin_repo }}"
        dest: "/home/{{ pi_user }}/raptor-network-spin"
        version: main
        force: yes
      become_user: "{{ pi_user }}"

    - name: Set raptor-network-spin directory ownership
      file:
        path: "/home/{{ pi_user }}/raptor-network-spin"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        recurse: yes

    - name: Start network-spinner with docker-compose
      shell: |
        cd /home/{{ pi_user }}/raptor-network-spin
        docker-compose up -d --build
      become_user: "{{ pi_user }}"

    # ============================================
    # RAPTOR-GATEWAY DEPLOYMENT
    # ============================================
    - name: Clone raptor-gateway repository
      git:
        repo: "{{ raptor_gateway_repo }}"
        dest: "/home/{{ pi_user }}/raptor-gateway"
        version: main
        force: yes
      become_user: "{{ pi_user }}"

    - name: Set raptor-gateway directory ownership
      file:
        path: "/home/{{ pi_user }}/raptor-gateway"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        recurse: yes

    - name: Create raptor-gateway .env file
      copy:
        dest: "/home/{{ pi_user }}/raptor-gateway/.env"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        mode: '0600'
        content: |
          NETWORK_STATUS_FILE=/var/run/network-status-vol/network-status
          LOCAL_MQTT_URL=tcp://localhost:1883
          CLOUD_MQTT_URL={{ cloud_mqtt_url }}
          CLOUD_MQTT_USER={{ cloud_mqtt_user }}
          CLOUD_MQTT_PASS={{ cloud_mqtt_pass }}
          RAPTOR_SITE={{ raptor_site }}
          RAPTOR_DEVICE={{ raptor_device }}
          SQLITE_PATH=/var/lib/raptor/gateway.db

    - name: Start raptor-gateway with docker-compose
      shell: |
        cd /home/{{ pi_user }}/raptor-gateway
        docker-compose up -d --build
      become_user: "{{ pi_user }}"

    # ============================================
    # RAPTOR-FRONTEND DEPLOYMENT
    # ============================================
    - name: Clone raptor-frontend repository
      git:
        repo: "{{ raptor_frontend_repo }}"
        dest: "/home/{{ pi_user }}/raptor-frontend"
        version: main
        force: yes
      become_user: "{{ pi_user }}"

    - name: Set raptor-frontend directory ownership
      file:
        path: "/home/{{ pi_user }}/raptor-frontend"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        recurse: yes

    - name: Create frontend static files directory
      file:
        path: /var/www/raptor
        state: directory
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        mode: '0755'

    # Note: Static files should be pre-built and copied, or build on Pi
    # For now, assume pre-built 'out/' directory exists in repo
    - name: Copy frontend static files
      shell: |
        cp -r /home/{{ pi_user }}/raptor-frontend/out/* /var/www/raptor/
      become: yes

    # ============================================
    # NGINX CONFIGURATION
    # ============================================
    - name: Configure nginx for Raptor frontend
      copy:
        dest: /etc/nginx/sites-available/raptor
        mode: '0644'
        content: |
          server {
              listen 80 default_server;
              server_name localhost;
              root /var/www/raptor;
              index index.html;

              # Disable caching for HTML files
              location ~* \.html$ {
                  add_header Cache-Control "no-cache, no-store, must-revalidate";
                  try_files $uri $uri/ =404;
              }

              # Static assets with caching
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|mp4|webm|woff|woff2)$ {
                  expires 1d;
                  add_header Cache-Control "public, immutable";
              }

              # Network status proxy (to network-spinner)
              location /api/network-status {
                  proxy_pass http://localhost:8111/status;
                  proxy_connect_timeout 2s;
                  proxy_read_timeout 2s;
                  add_header Access-Control-Allow-Origin *;
              }

              # SPA fallback - serve index.html for all routes
              location / {
                  try_files $uri $uri/ $uri.html /index.html;
              }
          }
      notify: Restart nginx

    - name: Enable Raptor nginx site
      file:
        src: /etc/nginx/sites-available/raptor
        dest: /etc/nginx/sites-enabled/raptor
        state: link
      notify: Restart nginx

    - name: Remove default nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Restart nginx

    - name: Enable nginx service
      systemd:
        name: nginx
        enabled: yes
        state: started

    # ============================================
    # DOCKER LOG ROTATION (Prevent SD card wear)
    # ============================================
    - name: Configure Docker log rotation
      copy:
        dest: /etc/docker/daemon.json
        mode: '0644'
        content: |
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
      notify: Restart docker

    # ============================================
    # AUTO-LOGIN SETUP
    # ============================================
    - name: Create autologin group
      group:
        name: autologin
        state: present

    - name: Add pi user to autologin group
      user:
        name: "{{ pi_user }}"
        groups: autologin
        append: yes

    - name: Configure LightDM auto-login
      blockinfile:
        path: /etc/lightdm/lightdm.conf
        marker: "# {mark} ANSIBLE MANAGED - AUTO LOGIN"
        insertafter: "\\[Seat:\\*\\]"
        block: |
          autologin-user={{ pi_user }}
          autologin-user-timeout=0

    - name: Set default target to graphical
      command: systemctl set-default graphical.target
      changed_when: false

    # ============================================
    # CHROMIUM KIOSK AUTOSTART
    # ============================================
    - name: Create autostart directory
      file:
        path: "/home/{{ pi_user }}/.config/autostart"
        state: directory
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        mode: '0755'

    - name: Configure Chromium kiosk autostart
      copy:
        dest: "/home/{{ pi_user }}/.config/autostart/chromium-kiosk.desktop"
        owner: "{{ pi_user }}"
        group: "{{ pi_user }}"
        mode: '0644'
        content: |
          [Desktop Entry]
          Type=Application
          Name=Chromium Kiosk
          Exec=bash -c "sleep 10 && /usr/bin/chromium --kiosk --noerrdialogs --disable-infobars --start-maximized --incognito {{ kiosk_url }}"
          Hidden=false
          X-GNOME-Autostart-enabled=true

    # ============================================
    # GPU / PERFORMANCE SETTINGS
    # ============================================
    - name: Configure GPU memory (CMA) in boot config
      lineinfile:
        path: /boot/firmware/config.txt
        regexp: '^dtoverlay=vc4-kms-v3d'
        line: 'dtoverlay=vc4-kms-v3d,cma-256'
        state: present

    - name: Set CPU to performance mode
      lineinfile:
        path: /boot/firmware/config.txt
        regexp: '^arm_freq='
        line: 'arm_freq=2400'
        state: present

    - name: Enable voltage boost
      lineinfile:
        path: /boot/firmware/config.txt
        regexp: '^over_voltage='
        line: 'over_voltage=4'
        state: present

    - name: Set CPU governor to performance
      copy:
        dest: /etc/default/cpufrequtils
        content: |
          GOVERNOR=performance
        mode: '0644'

    # ============================================
    # ZRAM SWAP
    # ============================================
    - name: Enable zramswap service
      systemd:
        name: zramswap
        enabled: yes
        state: started

    # ============================================
    # UNIQUE HOSTNAME PER PI
    # ============================================
    - name: Set unique hostname
      hostname:
        name: "raptor-{{ raptor_id }}"

    - name: Update /etc/hosts with new hostname
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1\traptor-{{ raptor_id }}"
        state: present

    # ============================================
    # FINAL REBOOT
    # ============================================
    - name: Reboot to apply all changes
      reboot:
        msg: "Rebooting to apply Raptor Pi configuration"
        reboot_timeout: 300

  handlers:
    - name: Restart lightdm
      systemd:
        name: lightdm
        state: restarted

    - name: Restart nginx
      systemd:
        name: nginx
        state: restarted

    - name: Restart docker
      systemd:
        name: docker
        state: restarted
